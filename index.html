<!DOCTYPE HTML>
<html>
  <head>
  	<meta name="viewport" content="width=640,user-scalable=no">
    <style>
      body {
        margin: 0px;
        padding: 0px;
        background: #000 url(images/2-bg.jpg) no-repeat;
      }
    </style>
  </head>
  <body>
  <script type='text/javascript' src='easeljs-0.8.0.min.js'></script>
  <script type='text/javascript' src='tweenjs-0.6.0.min.js'></script>

    <canvas id="myCanvas" width="640" height="1008" style="background:#eee;"></canvas>
    <script>

//global var

var move = 1;

var canvas = document.querySelector("#myCanvas");

var imgPath=[
'1-begin.png',
'1-up.png',
'2-bg.jpg',
'2-mu.png',
'3-bg.jpg',
'3-q1.png',
'3-q2.png',
'pai.png',
'q1.png',
'q2.png',
'rule.jpg',
'wei.png',
'zhong.png'
 ];
var imgObj={};
imgPath.forEach(function(v){
	var img = new Image();
	img.src = "images/"+v;
	img.onload=function(){
		imgObj[v] = img;

		if( Object.keys(imgObj).length == imgPath.length ){
			init();
		}
	}
});




//init center pos and stage, add background
var centerPos = {x:267, y:401};

var stage, bg, bitmap;

stage = new createjs.Stage(canvas);

bg = new createjs.Bitmap("images/1-bg.jpg");
stage.addChild(bg);

// add center dot
var shape = new createjs.Shape(  new createjs.Graphics().beginFill("#ff0000").drawCircle(0, 0, 4)  );
shape.alpha=0;
stage.addChild( shape );

function addClip(path, x,y,w,h){
	
	var shape = new createjs.Shape();
	shape.graphics.drawRect(x,y,w,h);

	var shape2 = new createjs.Shape();
	shape2.graphics.beginFill('#ff0000').drawRect(x,y,w,h);


	var obj = new createjs.Bitmap( imgObj[path] );
	obj.mask = shape;
	obj.hitArea = shape2;
	
	stage.addChild(obj);
	return obj;
}

// add hero bitmap 
var t1;
function init(){

	var begin = addClip("1-begin.png", 100, 648 , 440 , 88);
	var upload = addClip("1-up.png", 100, 543 , 440 , 88);

	upload.on("click", uploadFile )
	begin.on("click", gotoStage2 )

	bitmap = stage.addChild( new createjs.Bitmap( imgObj["q1.png"] ) ); 
	

	var b =bitmap.getBounds();

    if(b){
    	bitmap.regX = b.width/2;
    	bitmap.regY = b.height/2;
    	bitmap.scaleX = bitmap.scaleY = 0.5;
    	bitmap.x = canvas.width/2;
	}
	t1 = createjs.Tween.get(bitmap, {paused:true, position:300, onChange: function(){

	}}).to({ y: canvas.height }, 1500, createjs.Ease.getPowOut(2) ).call(function(){ 

	});
}


function uploadFile (e) {
	alert(111);
}
function gotoStage2 (e) {
	alert(222);
}


//Request Animation Frame
var startTime=new Date();

window.requestAnimFrame = (function(callback) {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
        function(callback) {
            window.setTimeout(callback, 1000 / 60);
        };
})();

function animate() {
    requestAnimFrame(animate);
    handleTick();
}
animate();


//Handle every tick
function handleTick(event) {
 	if(!move)return;
     if(typeof t1=='undefined') return;
     var d = new Date() - startTime;
     t1.setPosition( t1.position+d );
     startTime = new Date();
     
     stage.update();
}




// click to calc score

function clickHandle(e,data) {
	if(!move) return;
	t1.setPaused(true);
	var b =bitmap.getBounds();
	var center = bitmap.localToLocal(b.width/2, b.height/2, stage);
	var dx = center.x-centerPos.x;
	var dy = center.y-centerPos.y;
	var ds = 2* Math.sqrt(Math.pow(dx,2)+Math.pow(dy,2));
	var score = Math.max(0, 160-ds);
	console.log( score );
	move=0;

	saveImage();
}
bg.on("click", clickHandle );


//save snapshot of the canvas, and display

function saveImage(){

	 var bgCanvas = document.createElement('canvas');
	 bgCanvas.width = 322;
	 bgCanvas.height = 286;

	var bgContext = bgCanvas.getContext('2d');
	bgContext.drawImage(myCanvas, // source
	                    166, 306,   // source coordinates
	                    322, 286,   // source dimension
	                    0, 0,       // target coordinates
	                    322, 286);  // target dimensions


	console.log( bgCanvas.toDataURL() );
	var simg = new Image();
	simg.src= bgCanvas.toDataURL();

	bit = new createjs.Bitmap(simg);
	bit.x=bit.y=0;
	stage.addChild(bit);
	stage.update();
}



    </script>

  </body>
</html>
